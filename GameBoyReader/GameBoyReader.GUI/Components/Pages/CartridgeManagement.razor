@page "/cartridge_management"
@using GameBoyReader.Core.Models
@using GameBoyReader.Core.Services
@using GameBoyReader.Core.Utils

<h1>Cartridge Tools</h1>

@if (!ConnectionService.IsConnectionEstablished)
{
    <div class="connection-setup-warning">
        <h2>To use these tools you must first connect to your device. In order to do so, please proceed to <a href="/connection_setup" class="connection-setup-href">Connection Setup</a></h2>
    </div>
}

<div class="page-content-container">
    <h2>Cartridge boot bitmap</h2>
    <p>Cartridge boot bitmap is used by GameBoy to determine if inserted cartridge is valid and its contents are safe to execute.</p>
    <HxButton Color="ThemeColor.Primary" OnClick="CheckCartridgeBootBitmap" Enabled="ConnectionService.IsConnectionEstablished">Verify cartridge boot bitmap</HxButton>
    <div class="dump-result">
        @if (_showRetrievedBitmap && _retrievedBitmap.IsBitmapCorrect)
        {
            <p class="dump-success">Bitmap has been verified successfully. This means inserted cartridge is correct GameBoy cartridge.</p>
        }
        else
        @if (_showRetrievedBitmap && !_retrievedBitmap.IsBitmapCorrect)
        {
            <p class="dump-error">Received bitmap does not match valid GameBoy boot bitmap. This usually means its connector is dirty or it is malfunctioning.</p>
        }
    </div>
</div>

<div class="page-content-container">
    <h2>Cartridge information</h2>
    <HxButton Color="ThemeColor.Primary" OnClick="RetrieveCartridgeInformation" Enabled="ConnectionService.IsConnectionEstablished">Retrieve cartridge information</HxButton>
    <div class="dump-result">
        @if (_showCartridgeInformation)
        {
            <p>Game title: @_information.Name</p>
            <p>Cartridge type: @CartridgeTypeConverter.ConvertFromCartridgeTypeToString(_information.Type)</p>
            <p>ROM Size: @(32 * 1024 * (1 << _information.ROMSize))B</p>
            <p>RAM Size: @_information.RAMSize</p>
        } else
        {
            <p>Game title:</p>
            <p>Cartridge type:</p>
            <p>ROM Size:</p>
            <p>RAM Size:</p>
        }
    </div>
</div>

<div class="page-content-container">
    <h2>Dump cartridge</h2>
    <p>This tool allows you to copy cartridge's content onto your computer. Depending on the game this can take from few seconds up to few minutes.</p>
    <HxButton Color="ThemeColor.Primary" OnClick="DumpROM" Enabled="ConnectionService.IsConnectionEstablished">Dump cartridge ROM</HxButton>
</div>

<HxModal @ref="_saveROMModal" Title="Save ROM">
    <BodyTemplate>
        <HxInputText Label="File name" @bind-Value="@_fileName" Hint="This file will be saved in GameBoyReader folder you can find in your Documents." />
        @if (_saveReturnMessage != "")
        {
            <p>@_saveReturnMessage</p>
        }
        @if (_saveErrorMessage != "")
        {
            <p class="dump-error">@_saveErrorMessage</p>
        }
    </BodyTemplate>
	<FooterTemplate>
        <HxButton Color="ThemeColor.Success" OnClick="@SaveROM">Save</HxButton>
        <HxButton Color="ThemeColor.Danger" OnClick="@CancelROMSave">Cancel</HxButton>
    </FooterTemplate>
</HxModal>

@code {
    private static CartridgePreparationService _cartridgePreparationService = new();
    private static CartridgeDumperService _cartridgeDumper = new();
    private CartridgeInformation _information = new();
    private RetrievedBitmap _retrievedBitmap = new();
    private CartridgeContent _cartridgeContent = new();
    private HxModal _saveROMModal;
    private bool _showCartridgeInformation = false;
    private bool _showRetrievedBitmap = false;
    private bool _showSaveROMModal = false;
    private string _fileName = "game_dump.gb";
    private string _saveReturnMessage = "";
    private string _saveErrorMessage = "";

    private async Task RetrieveCartridgeInformation()
    {
        _information = await _cartridgePreparationService.RetrieveCartridgeInformation();
        _showCartridgeInformation = true;
    }

    private async Task CheckCartridgeBootBitmap()
    {
        _retrievedBitmap = await _cartridgePreparationService.ValidateBootBitmap();
        _showRetrievedBitmap = true;
    }

    private async Task DumpROM()
    {
        _cartridgeContent = await _cartridgeDumper.DumpCartridge();
        await _saveROMModal.ShowAsync();
    }

    private async Task SaveROM()
    {
        if (_fileName == "" || _fileName == null)
        {
            _saveReturnMessage = "File name cannot be empty.";
            return;
        }
        if (!(_fileName.EndsWith(".gb")))
        {
            _fileName += ".gb";
        }
        if (File.Exists(Path.Combine(RetrieveSaveLocation(), _fileName)))
        {
            _saveReturnMessage = "File of this name exists in " + Path.Combine(RetrieveSaveLocation(), _fileName) + ". Try another file name.";
            return;
        }

        try
        {
            await File.WriteAllBytesAsync(Path.Combine(RetrieveSaveLocation(), _fileName), _cartridgeContent.CartridgeByteContent.ToArray());
        }
        catch (Exception ex)
        {
            _saveErrorMessage = ex.Message;
        }
        _cartridgeContent = new();
        _fileName = "game_dump.gb";
        await _saveROMModal.HideAsync();
    }

    private async Task CancelROMSave()
    {
        _cartridgeContent = new();
        _fileName = "game_dump.gb";
        await _saveROMModal.HideAsync();
    }

    private static string RetrieveSaveLocation()
    {
        string result = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "GameBoyReader");
        return result;
    }
}
@page "/connection_setup"
@using GameBoyReader.Core.Services
@using System.Collections.ObjectModel

<h1>Connection Settings</h1>
<div class="page-content-container">

    <h3>This page allows you to connect to GameBoy Reader device. Choose COM port where your device is connected and press 'Connect'.</h3>
    <h4>Connection status: <span class="@GetConnectionClass()">@RetrieveConnectionStatus()</span></h4>
    <div class="connection-control-buttons d-flex align-items-center gap-4">
        <HxDropdownButtonGroup OnShown="RefreshPorts" class="fixed-dropdown">
            <HxDropdownToggleButton Color="ThemeColor.Primary" Enabled="@PortPickerEnabled()">@_pickedPort</HxDropdownToggleButton>
            <HxDropdownMenu>
                @foreach (var port in _comPorts)
                {
                    <HxDropdownItem OnClick="() => HandleDropdownItemClick(port)" >@port</HxDropdownItem>
                }
            </HxDropdownMenu>

        </HxDropdownButtonGroup>

        <HxButton OnClick="Connect" Color="ThemeColor.Success" Enabled="@ConnectButtonEnabled()">Connect to device</HxButton> <HxButton OnClick="Disconnect" Color="ThemeColor.Danger" Enabled="@DisconnectButtonEnabled()">Disconnect from device</HxButton>
    </div>

    @if (!(@_errorMessage == ""))
    {
        <h3 class="error-message">@_errorMessage</h3>
    }
</div>

@code {
    private ObservableCollection<string> _comPorts = new ObservableCollection<string>();
    private ArduinoSerialClient _serialClient = new();
    private string _pickedPort = ConnectionService.IsConnectionEstablished ? ConnectionService.SerialPort.PortName : "Found ports";
    private string _errorMessage = "";
    protected override void OnInitialized()
    {
        var ports = _serialClient.RetrieveAvailableCOMPorts();
        _comPorts.Clear();
        foreach (var port in ports)
        {
            _comPorts.Add(port);
        }
    }

    private string GetConnectionClass()
    {
        return ConnectionService.IsConnectionEstablished
            ? "device-connected"
            : "device-disconnected";
    }

    private bool PortPickerEnabled()
    {
        return !ConnectionService.IsConnectionEstablished;
    }

    private bool ConnectButtonEnabled() 
    {
        return !(_pickedPort == "Found ports") && !ConnectionService.IsConnectionEstablished;
    }

    private bool DisconnectButtonEnabled()
    {
        return ConnectionService.IsConnectionEstablished;
    }

    private void HandleDropdownItemClick(string port) => _pickedPort = port;

    private async Task Connect()
    {
        try
        {
            await ConnectionService.StartConnection(_pickedPort);
        } catch (Exception e)
        {
            _errorMessage = e.Message;
        }
        StateHasChanged();
    }

    private void Disconnect()
    {
        ConnectionService.StopConnection();
        StateHasChanged();
    }

    private string RetrieveConnectionStatus()
    {
        return ConnectionService.IsConnectionEstablished ? "Device connected" : "Device not connected";
    }

    private void RefreshPorts() {
    {
        var ports = _serialClient.RetrieveAvailableCOMPorts();
        _comPorts.Clear();
        foreach (var port in ports)
        {
            _comPorts.Add(port);
        }
    }
}
}
